<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-storage.html">

<link rel="import" href="error/error-404.html"></link>
<link rel="import" href="home/home-page.html"></link>
<link rel="import" href="login/login-page.html"></link>
<link rel="import" href="roster/roster-page.html"></link>
<link rel="import" href="register/register-page.html"></link>
<link rel="import" href="shared-styles.html"></link>
<link rel="import" href="custom-icons.html"></link>

<dom-module id="main-app">
  <template>
    <style include="shared-styles">

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }
      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      a.header-option {
        padding: 2px 0px 2px 0px;
        color: #ffffff;
        font-size: 12px;
        float:right;
        width: 65%;
      }

      a.header-option:hover {
        text-decoration: underline;
      }

      div.header-option-group {
        float: right;
        margin-left: -25px;
      }

      a.drawer-option {

      }

      .header-icon {
        margin-top: 2px;
      }

      img.header-avatar {
        height: 48px;
        width: 48px;
      }

      a.main-title {
        color: #fff;
      }

      a.main-title:visited {
        color: #fff;
      }

      a paper-icon-button {
        color: #ffffff;
      }

      a:visited paper-icon-button {
        color: #ffffff;
      }

    </style>

    <iron-media-query
      query="(max-width: 414px)"
      query-matches="{{isMobile}}">
    </iron-media-query>
    <iron-media-query
      query="(max-width: 640px)"
      query-matches="{{isTablet}}">
    </iron-media-query>

    <firebase-app
      name="19giap"
      auth-domain="giap-80ec2.firebaseapp.com"
      database-url="https://giap-80ec2.firebaseio.com"
      api-key="AIzaSyBvWg_JPft53Qn_-FaSpim-P9tNnjzJeus"
      storage-bucket="giap-80ec2.appspot.com">
    </firebase-app>

    <firebase-auth
      id="auth"
      app-name="19giap"
      user="{{user}}"
      signed-in="{{signedIn}}">
    </firebase-auth>

    <firebase-document
      id="query"
      app-name="19giap"
      path="/users/[[user.uid]]"
      data="{{userData}}">
    </firebase-document>

    <firebase-storage
      id="storage"
      app-name="19giap">
    </firebase-storage>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}">
    </app-route>

    <app-drawer-layout fullbleed>
      <!-- Drawer content -->
      <app-drawer>
        <div hidden$=[[!isTablet]]>
          <paper-icon-button hidden$=[[!isTablet]] class="float-right"
              icon="hardware:keyboard-arrow-left" drawer-toggle></paper-icon-button>
        </div>
        <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
          <a class="drawer-option" id="home" name="home" href="/home">Home</a>
          <a class="drawer-option" name="about" href="/about">About</a>
          <a class="drawer-option" name="register" href="/register">Register</a>
          <a class="drawer-option" name="roster" href="/roster">Roster</a>
          <a class="drawer-option" name="comms" href="/comms">Communications</a>
          <a class="drawer-option" name="resources" href="/resources">Resources</a>
        </iron-selector>
      </app-drawer>

      <!-- Main content -->
      <app-header-layout has-scrolling-region>

        <app-header condenses reveals effects="waterfall">
          <app-toolbar>
            <paper-icon-button icon="icons:menu" drawer-toggle></paper-icon-button>
            <a main-title href="/home" title="Home" class="serif main-title">19.GIAP</div>
            <spacer></spacer>
            <div hidden$="[[signedIn]]">
              <a href="/login" title="Sign In" tabindex="-1">
                <paper-icon-button class="header-icon" icon="icons:account-circle"></paper-icon-button>
              </a>
              <div hidden$=[[isMobile]] class="header-option-group">
                <a class="header-option" href="/login" title="Sign In" tabindex="-1">Login</a>
                <a class="header-option" href="/register" title="Register" tabindex="-1">Register</a>
              </div>
            </div>
            <div hidden$="[[!signedIn]]">
              <a href="/roster/[[user.uid]]" title="Profile" tabindex="-1">
                <img class="header-avatar" src="[[userData.avatarUrl]]">
              </a>
              <div hidden$=[[isMobile]] class="header-option-group">
                <a class="header-option" href="/roster/[[user.uid]]" title="Profile" tabindex="-1">{{userData.username}}</a>
                <a class="header-option" title="Sign Out" tabindex="-1" on-tap="signOut">Sign Out</a>
              </div>
            </div>
          </app-toolbar>

        </app-header>

        <iron-pages
          id="ironPages"
          selected="[[page]]"
          attr-for-selected="name"
          fallback-selection="error-404"
          role="main-app">
          <home-page id="homePage" name="home"></home-page>
          <login-page id="loginPage" name="login"
              user="{{user}}" signed-in="{{signedIn}}"></login-page>
          <register-page id="registerPage" name="register"
            user="{{user}}" signed-in="{{signedIn}}"></register-page>
          <roster-page id="rosterPage" name="roster" route={{subroute}}></roster-page>
          <error-404 name="error-404"></error-404>
        </iron-pages>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    Polymer({
      is: 'main-app',

      properties: {
        user: Object,
        signedIn: {
          type: Boolean,
          observer: '_signedInChanged',
          notify: true
        },
        page: {
          type: String,
          reflectToAttribute: true
        }
      },

      observers: [
        '_routePageChanged(routeData.page)'
      ],

      signOut: function() {
        console.log('sign out');
        this.$.auth.signOut().then(function() {
          console.log('signed out successfully');
        }, function(error) {
          console.log('sign out error');
          console.log(error);
        })
      },

      _signedInChanged: function(signedIn) {
        console.log('signedIn changed to ' + signedIn);
      },

      _routePageChanged: function(page) {
        this.page = page || 'home';
      }

    });
  </script>
</dom-module>
